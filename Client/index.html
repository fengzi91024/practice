<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>首页</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      table {
        width: 800px;
        height: 150px;
        margin: 150px auto;
      }
      thead {
        background-color: #3f87a6;
        color: #fff;
      }
      tbody {
        background-color: #e4f0f5;
      }
      tbody td {
        text-align: center;
      }
      thead th:nth-last-child(1) {
        width: 120px;
      }
      table a {
        color: black;
        text-decoration: none;
      }
      table a:hover {
        color: red;
      }
      /* 修改form 表单 */
      form {
        box-sizing: border-box;
        width: 300px;
        margin: 150px auto;
        padding: 20px;
        border: 1px solid black;
      }
      form button {
        width: 200px;
        margin: 15px;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <table>
        <thead>
          <tr>
            <th>id</th>
            <th>用户名</th>
            <th>性别</th>
            <th>手机号</th>
            <th>密码</th>
            <th>账号状态</th>
            <th>注册时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
    <div id="update">
      <form>
        <label for="num">序号:</label>
        <input type="text" id="num" name="id" />
        <br />
        <label for="name">用户名:</label>
        <input type="text" id="name" name="name" />
        <br />
        <label for="gender">性别</label>
        <input type="text" id="gender" name="gender" />
        <br />
        <label for="phone">手机号</label>
        <input type="text" id="phone" name="phone" />
        <br />
        <label for="password">密码</label>
        <input type="text" id="password" name="password" />
        <br />
        <label for="state">账号状态</label>
        <input type="text" id="state" name="state" />
        <br />
        <label for="date">注册时间</label>
        <input type="text" id="date" name="date" />
        <div>
          <button id="btn" type="button">修改</button>
        </div>
      </form>
    </div>

    <script>
      //获取根标签
      const root = document.getElementById("root");
      //获取tbody
      const list = document.getElementById("list");

    
        //获取服务器发来的请求
        (async (cb) => {
          try {
            const res = await axios({
              method: "get",
              url: "http://127.0.0.1:4000/users",
              params: {
                page: 1,
                pageSize: 2,
              },
            });
            console.log(res.data);
            cb(res.data.data);
          } catch (error) {
            console.log(error, "获取数据失败");
          }
        })(handleData);

        //处理数据
        function handleData(Arr) {
          for (let index = 0; index < Arr.length; index++) {
            const element = Arr[index];
            const { id, username, password, user_type, createdAt } = element;
            const state = "1";
            //创建tr标签
            const tr = document.createElement("tr");

            let userState = "启用";
            //判断用户状态 禁用和启用
            if (state !== "1") {
              userState = "禁用";
            }

            const date = Intl.DateTimeFormat("zh-CN").format(
              new Date(createdAt)
            );

            //插入数据
            tr.insertAdjacentHTML(
              "afterbegin",
              `<td class="id">${id}</td><td>${username}</td><td>男</td><td>${user_type}</td><td>${password}</td>
                  <td>${userState}</td><td>${date}</td>
                  <td id="handler"><a href="./index.html" class="delete-link">删除</a> <a href="./index.html" class="update-link">修改</a></td>
                  `
            );

            //将数据插入表格中
            list.appendChild(tr);
          }
   
        list.addEventListener("click", function (event) {
          event.preventDefault(); //阻止默认行为
          //判断是否点击删除按钮
          if (event.target.classList.contains("delete-link")) {
            const check = window.confirm("是否删除该元素");

            //判断是否删除
            if (check !== false) {
              axios({
                method: "delete",
                url: "http://127.0.0.1:4000/delete",
              })
                .then((result) => {
                  const del = event.target.closest("tr");
                  del.remove();
                })
                .catch((err) => {});
            }
          }
          function updateInputValues(tr, inputArr) {
            const tdList = tr.children; // 获取行内所有的td元素
            const lastTd = tr.lastElementChild; // 最后一个td可能包含操作按钮，需要排除
            for (let i = 0; i < tdList.length; i++) {
              const td = tdList[i];
              if (td !== lastTd) {
                // 排除最后一个td元素
                const input = inputArr[i]; // 获取对应的input元素
                console.log(inputArr[i]);
                if (input) {
                  
                  input.value = td.textContent; // 将td的内容赋值给input
                }
              }
            }
          }

       
          if (event.target.classList.contains("update-link")) {
            //判断是否点击更新
            if (event.target.classList.contains("update-link")) {
              const tr = event.target.closest("tr");
              const id =tr.querySelector(".id").textContent
              const inputArr = document.querySelectorAll("input");
              updateInputValues(tr, inputArr);
      
              // 获取修改按钮
              const btn = document.getElementById("btn");
              const inputs = document.querySelectorAll("input");
          
              const data = {};

              btn.addEventListener("click", () => {
                inputs.forEach((input) => {
                  if (input.name) {
                    data[input.name] = input.value;
                  }
                });
                data.id=id
                axios({
                  method: "POST",
                  url: "http://localhost:4000/update",
                  data: data,
                })
                .then((res)=>{
                  if(res.status==200){
                    window.location.reload();
                  }
                })
              });
            }
          }
        });
      }
    </script>
  </body>
</html>
